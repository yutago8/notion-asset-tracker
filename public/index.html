<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Notion Asset Tracker</title>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
      :root { --fg:#111; --muted:#666; --line:#eee; --accent:#2563eb; }
      body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; color: var(--fg); }
      .container { max-width: 1080px; margin: 0 auto; }
      .header { display:flex; align-items:center; gap:12px; flex-wrap: wrap; }
      .muted { color: var(--muted); }
      .controls { margin:10px 0; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
      .controls label { font-size: 14px; }
      .kpi { margin: 8px 0 12px; }
      .kpi .value { font-size: 28px; font-weight: 600; }
      .kpi .sub { font-size: 12px; color:var(--muted); }
      #chart { width: 100%; max-width: 100%; }
      table { width:100%; border-collapse: collapse; }
      td { border-bottom: 1px solid var(--line); padding: 6px 4px; vertical-align: top; }
      h3 { margin: 8px 0; font-size: 16px; }
      .cols { display:flex; gap:24px; flex-wrap:wrap; }
      .col { min-width:320px; flex: 1 1 360px; }
      @media (max-width: 768px) {
        body { margin: 16px; }
        .kpi .value { font-size: 22px; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1 style="margin:0;">Dashboard</h1>
        <div class="muted" id="last-updated"></div>
      </div>
      <div class="controls">
        <label>単位
          <select id="unit-select">
            <option value="1">円</option>
            <option value="1000">千円</option>
            <option value="10000" selected>万円</option>
            <option value="1000000">百万円</option>
          </select>
        </label>
        <label>年
          <select id="year-select"></select>
        </label>
        <label>月
          <select id="month-select">
            <option value="all">全期間</option>
            <option value="01">01</option>
            <option value="02">02</option>
            <option value="03">03</option>
            <option value="04">04</option>
            <option value="05">05</option>
            <option value="06">06</option>
            <option value="07">07</option>
            <option value="08">08</option>
            <option value="09">09</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
          </select>
        </label>
      </div>
      <div class="kpi">
        <div class="value" id="kpi-total">—</div>
        <div class="sub" id="kpi-sub"></div>
      </div>

      <div style="position:relative; width:100%;">
        <canvas id="chart" height="320"></canvas>
      </div>
      <hr style="margin:24px 0;"/>

      <div class="cols">
        <div class="col">
          <h3 id="h-forecast">Forecast</h3>
          <div class="muted" id="forecast-total"></div>
          <table id="tbl-forecast" border="0" cellpadding="6"></table>
        </div>
        <div class="col">
          <h3 id="h-cash">Cash</h3>
          <div class="muted" id="cash-total"></div>
          <table id="tbl-cash" border="0" cellpadding="6"></table>
        </div>
      </div>
      <div class="cols" style="margin-top:24px;">
        <div class="col">
          <h3>Next 60 Days – Due</h3>
          <table id="tbl-due" border="0" cellpadding="6"></table>
        </div>
        <div class="col">
          <h3>&gt;=10k – Watchlist</h3>
          <table id="tbl-watch" border="0" cellpadding="6"></table>
        </div>
        <div class="col">
          <h3>Unconfirmed / To Check</h3>
          <table id="tbl-unconfirmed" border="0" cellpadding="6"></table>
        </div>
      </div>

      <hr style="margin:24px 0;"/>
      <div class="cols">
        <div class="col">
          <h3>Quick Input (Transactions)</h3>
          <div class="muted" style="margin-bottom:6px;">編集用パスワード（WRITE_SECRET）を入力して保存できます。個人運用向けの簡易保護です。</div>
          <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
            <input id="admin-secret" type="password" placeholder="WRITE_SECRET" style="padding:6px;" />
            <button id="btn-save-secret">Set</button>
            <button id="btn-clear-secret">Clear</button>
            <span id="secret-status" class="muted"></span>
          </div>
          <div style="display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:8px;">
            <input id="f-title" placeholder="Title" />
            <input id="f-date" type="date" />
            <input id="f-amount" type="number" step="1" placeholder="Amount (負は支出)" />
            <select id="f-type"></select>
            <input id="f-due" type="date" placeholder="Due Date" />
            <select id="f-method"></select>
            <label><input id="f-confirmed" type="checkbox" /> Amount Confirmed</label>
            <label><input id="f-verified" type="checkbox" /> Verified</label>
          </div>
          <div style="margin-top:8px; display:flex; gap:8px;">
            <button id="btn-submit">Add Transaction</button>
            <span id="submit-msg" class="muted"></span>
          </div>
        </div>
      </div>

      <script>
        async function fetchJSON(url){ const r = await fetch(url); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }
        function byDateAsc(a,b){ return (a.dateISO||a.date).localeCompare(b.dateISO||b.date); }
        function fmtNumber(n){ return new Intl.NumberFormat('ja-JP',{ maximumFractionDigits: 2 }).format(n); }
        function getUnit(){ const sel = document.getElementById('unit-select'); const div = Number(sel.value) || 1; const label = sel.options[sel.selectedIndex].text; return { div, label }; }
        function nextMonth(ym){ const [y,m] = ym.split('-').map(Number); const d = new Date(y, m-1, 1); d.setMonth(d.getMonth()+1); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
        function renderTable(el, rows, unit){
          const th = `<tr class="muted"><td>Date</td><td>Title</td><td style="text-align:right;">Amount (${unit.label})</td></tr>`;
          const tr = rows.map(r=>{ const val = (r.amount||0)/unit.div; return `<tr><td>${r.date}${r.dueDate?`<div class=muted>due ${r.dueDate}</div>`:''}</td><td>${r.title}</td><td style="text-align:right;">${fmtNumber(val)}</td></tr>`; }).join('');
          el.innerHTML = th + tr;
        }

        async function main(){
          const cfg = await fetchJSON('/api/config');
          const nf = new Intl.NumberFormat(undefined,{ style:'currency', currency: cfg.baseCurrency || 'JPY' });

          // Load data
          const snap = await fetchJSON('/api/snapshots');
          const SNAP_ALL = (snap.items || []).sort(byDateAsc);
          let TR_ALL = [];
          try { const tr = await fetchJSON('/api/transactions'); TR_ALL = tr.items || []; } catch (_) { TR_ALL = []; }

          // Current KPI
          let currentTotal = null; let currentChange = null; let currentFrom = '';
          try {
            const comp = await fetchJSON('/api/compute');
            currentTotal = comp.valuation?.totalUSD ?? null;
            currentChange = typeof comp.changeUSD === 'number' ? comp.changeUSD : null;
            currentFrom = 'now';
          } catch (_) {
            const last = SNAP_ALL[SNAP_ALL.length - 1];
            if (last) { currentTotal = last.totalUSD; currentChange = typeof last.changeUSD === 'number' ? last.changeUSD : null; currentFrom = last.dateISO; }
          }
          const u0 = getUnit();
          if (currentTotal != null) {
            document.getElementById('kpi-total').textContent = nf.format(currentTotal);
            const sub = `${fmtNumber(currentTotal / u0.div)} ${u0.label}` + (currentChange!=null ? `  (${currentChange>=0?'+':''}${fmtNumber(currentChange / u0.div)} ${u0.label})` : '') + (currentFrom ? ` • as of ${currentFrom}` : '');
            document.getElementById('kpi-sub').textContent = sub;
          } else {
            document.getElementById('kpi-total').textContent = '—';
            document.getElementById('kpi-sub').textContent = 'No data yet';
          }

          // Year/month selectors
          const yearsSet = new Set(SNAP_ALL.map(i=> (i.dateISO||'').slice(0,4)));
          if (TR_ALL.length) TR_ALL.forEach(t=> yearsSet.add((t.date||'').slice(0,4)));
          const years = Array.from(yearsSet).filter(Boolean).sort();
          const ysel = document.getElementById('year-select');
          const nowY = String(new Date().getFullYear());
          const effectiveNowY = years.includes(nowY) ? nowY : (years[years.length-1] || nowY);
          ysel.innerHTML = years.map(y=>`<option value="${y}" ${y===effectiveNowY?'selected':''}>${y}</option>`).join('');
          const msel = document.getElementById('month-select');
          const nowM = String(new Date().getMonth()+1).padStart(2,'0');
          msel.value = years.includes(nowY) ? nowM : 'all';

          document.getElementById('unit-select').addEventListener('change', () => {
            const u=getUnit(); if (currentTotal!=null){ document.getElementById('kpi-sub').textContent = `${fmtNumber(currentTotal/u.div)} ${u.label}` + (currentChange!=null?`  (${currentChange>=0?'+':''}${fmtNumber(currentChange/u.div)} ${u.label})`: '') + (currentFrom?` • as of ${currentFrom}`:''); }
            renderChart(SNAP_ALL, nf); renderTables(TR_ALL);
          });
          ysel.addEventListener('change', () => { renderChart(SNAP_ALL, nf); renderTables(TR_ALL); updateHeadings(); });
          msel.addEventListener('change', () => { renderChart(SNAP_ALL, nf); renderTables(TR_ALL); updateHeadings(); });

          function updateHeadings(){
            const year = ysel.value, month = msel.value; const ym = month==='all' ? year : `${year}-${month}`;
            document.getElementById('h-forecast').textContent = `Forecast – ${ym}`;
            document.getElementById('h-cash').textContent = `Cash – ${ym}`;
          }

          const LOG_CACHE = new Map(); // key: year -> entries
          async function getAssetLogFor(year){
            if (LOG_CACHE.has(year)) return LOG_CACHE.get(year);
            try { const r = await fetch(`/api/asset-log?from=${year}-01-01&to=${year}-12-31`); const j = await r.json(); const arr = j.items||[]; LOG_CACHE.set(year, arr); return arr; } catch(_) { LOG_CACHE.set(year, []); return []; }
          }

          async function renderChart(SNAPS, nf){
            const year = ysel.value; const month = msel.value;
            const filtered = SNAPS.filter(i=> (i.dateISO||'').startsWith(year+'-')).filter(i=> month==='all' ? true : (i.dateISO||'').slice(5,7)===month);
            // Fetch asset log for year and build union labels
            const logs = await getAssetLogFor(year);
            const logsFiltered = logs.filter(i=> month==='all' ? true : (i.dateISO||'').slice(5,7)===month);
            const allDatesSet = new Set([ ...filtered.map(i=>i.dateISO), ...logsFiltered.map(i=>i.dateISO) ]);
            const allDates = Array.from(allDatesSet).sort();
            const labels = allDates.map(d=> month==='all' ? d.slice(5) : d.slice(8));
            const u = getUnit();
            const totalMap = new Map(filtered.map(i=> [i.dateISO, (i.totalUSD||0)/u.div]));
            const values = allDates.map(d=> totalMap.get(d) ?? null);
            // Bar dataset for changes
            const changeMap = new Map(logsFiltered.map(i=> [i.dateISO, (i.change||0)/u.div]));
            const changes = allDates.map(d=> changeMap.get(d) ?? 0);
            const chartEl = document.getElementById('chart');
            chartEl.width = chartEl.width; // reset
            if (allDates.length) {
              new Chart(chartEl, { type:'bar', data:{ labels, datasets:[
                { type:'line', label:`Total (${u.label})`, data:values, borderColor:varAccent(), backgroundColor:'rgba(37,99,235,0.15)', fill:true, tension:0.2, yAxisID:'y' },
                { type:'bar', label:`Change (${u.label})`, data:changes, backgroundColor:'rgba(220,38,38,0.35)', borderColor:'#dc2626', yAxisID:'y1' }
              ]}, options:{ responsive:true, plugins:{ legend:{display:true}, title:{ display:true, text: `${year}${month==='all'?'':'-'+month} – Total & Changes (${u.label})` } }, interaction:{ mode:'index', intersect:false }, scales:{ y:{ position:'left', ticks:{ callback:v=>`${fmtNumber(Number(v))} ${u.label}` } }, y1:{ position:'right', grid:{ drawOnChartArea:false }, ticks:{ callback:v=>`${fmtNumber(Number(v))} ${u.label}` } } } } });
            } else {
              const ctx = chartEl.getContext('2d'); ctx.fillStyle='#666'; ctx.font='14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial'; ctx.fillText('No snapshots to display for selected period.',12,24);
            }
          }

          function varAccent(){ return getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#2563eb'; }

          function renderTables(TR){
            const year = ysel.value; const month = msel.value; const ym = month==='all'? null : `${year}-${month}`;
            const now = new Date(); const inYear = d => (d||'').startsWith(year+'-'); const inYM = d => ym ? (d||'').startsWith(ym) : true;
            const u = getUnit();
            const forecast = TR.filter(x=> x.amountConfirmed && inYear(x.date) && inYM(x.date));
            const cash = TR.filter(x=> x.verified && inYear(x.date) && inYM(x.date));
            const due = TR.filter(x=> x.isDueSoon).sort((a,b)=> (a.dueDate||'').localeCompare(b.dueDate||''));
            const nextYm = ym ? nextMonth(ym) : null;
            const watch = TR.filter(x=> x.gte10k && inYear(x.date) && (ym ? (inYM(x.date) || (x.date||'').startsWith(nextYm)) : true));
            const unconfirmed = TR.filter(x=> inYear(x.date) && inYM(x.date) && (!x.amountConfirmed || (x.dueDate && new Date(x.dueDate) < now)));
            document.getElementById('forecast-total').textContent = `Total: ${fmtNumber(forecast.reduce((s,x)=>s+(x.amount||0),0)/u.div)} ${u.label}`;
            document.getElementById('cash-total').textContent = `Total: ${fmtNumber(cash.reduce((s,x)=>s+(x.amount||0),0)/u.div)} ${u.label}`;
            renderTable(document.getElementById('tbl-forecast'), forecast.slice(0,30), u);
            renderTable(document.getElementById('tbl-cash'), cash.slice(0,30), u);
            renderTable(document.getElementById('tbl-due'), due.slice(0,30), u);
            renderTable(document.getElementById('tbl-watch'), watch.slice(0,30), u);
            renderTable(document.getElementById('tbl-unconfirmed'), unconfirmed.slice(0,30), u);
          }

          // initial
          await renderChart(SNAP_ALL, nf);
          renderTables(TR_ALL);
          const last = SNAP_ALL[SNAP_ALL.length - 1];
          document.getElementById('last-updated').textContent = last ? `Last: ${last.dateISO}` : '';
        }
        main();
      </script>
      <script>
        // Quick Input wiring
        (async function(){
          const $ = (id)=>document.getElementById(id);
          const secretKey = 'WRITE_SECRET';
          const saved = localStorage.getItem(secretKey);
          if (saved) { $('admin-secret').value = saved; $('secret-status').textContent = 'Secret loaded'; }
          $('btn-save-secret').onclick = ()=>{ const v=$('admin-secret').value; localStorage.setItem(secretKey, v||''); $('secret-status').textContent = v? 'Secret set':'Secret cleared'; };
          $('btn-clear-secret').onclick = ()=>{ localStorage.removeItem(secretKey); $('admin-secret').value=''; $('secret-status').textContent = 'Secret cleared'; };

          // fill defaults
          const today = new Date(); const dstr = today.toISOString().slice(0,10); $('f-date').value = dstr;
          // meta options
          try {
            const meta = await (await fetch('/api/transactions-meta')).json();
            $('f-type').innerHTML = (meta.transactionTypes||['Expense','Income','Refund']).map(x=>`<option value="${x}">${x}</option>`).join('');
            const methods = meta.paymentMethods||[]; const opts = methods.map(x=>`<option value="${x}">${x}</option>`).join(''); $('f-method').innerHTML = `<option value="">(none)</option>`+opts;
          } catch(_) {
            $('f-type').innerHTML = ['Expense','Income','Refund'].map(x=>`<option value="${x}">${x}</option>`).join(''); $('f-method').innerHTML = `<option value="">(none)</option>`;
          }

          $('btn-submit').onclick = async ()=>{
            const title=$('f-title').value?.trim(); const date=$('f-date').value; const amount=Number($('f-amount').value);
            if(!title||!date||!Number.isFinite(amount)){ $('submit-msg').textContent='title/date/amount は必須です'; return; }
            const payload = {
              title,
              date,
              amount,
              transactionType: $('f-type').value || undefined,
              dueDate: $('f-due').value || undefined,
              amountConfirmed: $('f-confirmed').checked,
              verified: $('f-verified').checked,
              paymentMethod: $('f-method').value || undefined,
            };
            const headers = { 'Content-Type':'application/json' };
            const sec = $('admin-secret').value || localStorage.getItem(secretKey) || '';
            if (sec) headers['Authorization'] = 'Bearer '+sec;
            $('btn-submit').disabled = true; $('submit-msg').textContent = 'Saving...';
            try {
              const r = await fetch('/api/transactions-create', { method:'POST', headers, body: JSON.stringify(payload) });
              const j = await r.json();
              if(!r.ok){ $('submit-msg').textContent = (j.error||'error'); }
              else { $('submit-msg').textContent = 'Saved ✓'; $('f-title').value=''; $('f-amount').value=''; }
            } catch(e){ $('submit-msg').textContent = String(e); }
            finally { $('btn-submit').disabled = false; }
          };
        })();
      </script>
    </div>
  </body>
  </html>
